# DTC AI Agent 系统功能总览（Roadmap）

## 0. 系统目标
构建一个面向 DTC 电商场景的 AI 客服 Agent 系统，实现自动客服 + 人工客服协同，具备完整权限控制、流程可追溯与可扩展架构。

技术栈：
- Frontend：Next.js + TailwindCSS
- Backend：FastAPI
- Auth / DB：Supabase
- AI Agent：Kimi（全本 Agent）
- RAG：阿里云百炼

---

## 1. 身份系统（Auth & Profile）

### 1.1 登录方式
- 邮箱 + 密码登录
- 邮箱注册 + 邮箱验证
- Google 登录
- Apple 登录

### 1.2 用户资料（Profile）
- user_profiles 表
  - user_id
  - role（customer / admin）
  - display_name
  - avatar_url
  - created_at
- 新用户注册后自动创建 profile（trigger）
- 用户可修改：
  - display_name
  - avatar_url
- 用户不可修改：
  - role

---

## 2. 角色与权限（RBAC）

### 2.1 角色定义
- customer：普通用户（C 端）
- admin：客服 / 运营 / 管理员

### 2.2 权限规则
- customer：
  - 只能访问自己的数据
  - 只能调用 /api/** 接口
- admin：
  - 可访问所有用户数据（仅通过后端）
  - 可调用 /admin/** 接口
  - 可生成邀请码
  - 可进行人工审批

---

## 3. 邀请制客服系统（Admin Invite）

### 3.1 邀请码生成（Admin）
- 管理端生成邀请码
- 邀请码属性：
  - 一次性使用
  - 可设置过期时间
  - 可选绑定邮箱
- 数据库存储 hash，不存明文

### 3.2 注册时填写邀请码（主流程）
- 注册表单包含可选邀请码字段
- 邀请码正确：
  - 注册完成后直接成为 admin
- 未填写或填写错误：
  - 注册为 customer

### 3.3 注册后兑换邀请码（兜底）
- 已登录用户可输入邀请码
- 校验成功后升级为 admin

---

## 4. C 端用户系统（H5 / App）

### 4.1 页面
- 登录页
- 注册页
- 聊天页
- 我的订单页（Mock）
- 个人资料页
- 邀请码兑换页（可选）

### 4.2 聊天能力
- 创建会话（conversations）
- 发送消息（messages）
- SSE / 流式回复
- AI 自动回复
- 对话上下文保持

---

## 5. AI Agent（核心）

### 5.1 意图识别（Router）
- FAQ
- WISMO（物流）
- Return（退货）
- Exchange（换货）
- Fallback

### 5.2 工作流（Flow）
- ReturnFlow
- ExchangeFlow
- WISMOFlow
- 通用问答 Flow

### 5.3 规则引擎
- 是否超过 30 天
- 商品状态校验
- 是否符合政策
- 金额阈值（>=50 触发审批）

---

## 6. RAG 知识库（百炼）

### 6.1 知识来源
- 退货政策
- 物流政策
- FAQ
- 客服 SOP

### 6.2 RAG 行为
- Top-K 检索
- 返回证据片段
- 注入 Agent 推理上下文
- 记录命中结果

---

## 7. 数据模型（核心表）

### 7.1 会话
- conversations
- messages

### 7.2 订单（Mock）
- orders
- order_items

### 7.3 售后
- returns
- approval_tasks

### 7.4 Agent 可观测性
- agent_events
  - ROUTE_DECISION
  - TOOL_CALL
  - POLICY_HIT
  - ERROR

---

## 8. 客服工作台（Admin Web）

### 8.1 Inbox
- 会话列表（跨用户）
- 状态筛选
- 风险标识

### 8.2 会话详情
- 聊天记录
- 接管（Human Takeover）
- 手动回复
- AI 建议回复

### 8.3 上下文面板
- 用户信息
- 订单信息
- 规则命中
- RAG 证据
- Agent 事件时间线

---

## 9. 审批系统

### 9.1 触发条件
- 金额超过阈值
- 规则冲突
- 模型低置信度

### 9.2 审批流程
- 创建审批任务
- Admin 审批：
  - Approve
  - Reject
- 结果回写 Flow

---

## 10. 数据隔离与安全

### 10.1 RLS
- 所有业务表启用 RLS
- customer 仅访问自身数据
- admin 不可前端直连数据库

### 10.2 后端安全
- /api 与 /admin 路由隔离
- JWT 验证
- role 校验
- service_role 仅在后端使用

---

## 11. 审计与可观测性

- agent_events 全量记录
- 对话 trace 回放
- 审批操作留痕
- 邀请码使用记录

---

## 12. 未来扩展（暂不实现）

- 多客服协作
- 客服分配策略
- 真实支付 / 退款接口
- 真实电商平台订单接入
- 数据分析 Dashboard
- 多语言支持

---

## 13. 实施顺序建议

1. Auth + Profile + Role
2. C 端聊天最小闭环
3. Agent Router + Flow
4. RAG 接入
5. Admin Inbox
6. 审批系统
7. 可观测性完善
