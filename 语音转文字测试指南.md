# 🎤 语音转文字功能测试指南

## ✅ 准备工作已完成

### 后端服务
- ✅ 运行在 http://localhost:8000
- ✅ 阿里云ASR配置已加载：
  - AppKey: WMlfe00dnu4QA3Zp
  - AccessKeyID: LTAI5tAhwJe9nW196Zdwnsdp
  - AccessKeySecret: 已配置

### 前端服务
- ✅ 运行在 http://localhost:3000

## 📝 测试步骤

### 1. C端用户测试（自动转写）

1. 打开浏览器访问：http://localhost:3000/c/assistant
2. 登录用户账号（"勿相忘"）
3. 点击输入框左侧的"麦克风"图标
4. 长按"按住说话"按钮，说一段话（比如"你好，我想咨询一下退货流程"）
5. 松开按钮发送
6. 查看后端控制台日志，应该看到：
   ```
   下载音频: https://...
   音频大小: xxx bytes
   调用阿里云ASR API...
   ASR响应状态码: 200
   转写成功: 你好我想咨询一下退货流程
   ```

### 2. C端用户测试（右键菜单转写）

1. 在已发送的语音消息上**右键点击**
2. 会弹出菜单，显示"语音转文字"
3. 点击"语音转文字"
4. 稍等片刻，转写完成后文本会显示在语音消息下方

### 3. S端客服测试

1. 打开浏览器访问：http://localhost:3000/admin/inbox
2. 登录管理员账号（"苟富贵"）
3. 选择一个包含语音消息的会话
4. 在语音消息上**右键点击**
5. 点击"语音转文字"
6. 转写结果会显示在消息下方

## 🔍 可能遇到的问题

### 问题1：转写返回错误信息

**原因**：webm格式可能不被阿里云直接支持

**解决方案**：
1. 检查后端日志中的错误信息
2. 可能需要将webm转换为wav格式
3. 或者在前端录音时就使用wav格式

### 问题2：Token获取失败

**错误信息**："获取阿里云token失败"

**解决方案**：
1. 检查AccessKey ID和Secret是否正确
2. 检查阿里云账号是否开通了智能语音交互服务
3. 检查网络连接

### 问题3：HTTP 400/401错误

**解决方案**：
1. 确认AppKey是否正确
2. 确认Token是否有效
3. 查看阿里云控制台的API调用日志

## 🛠️ 调试技巧

### 查看后端日志
后端控制台会输出详细的调试信息：
- 音频下载状态
- 音频大小
- ASR API调用状态
- 响应内容

### 查看前端Network
1. 打开浏览器开发者工具（F12）
2. 切换到Network标签
3. 发送语音后查看：
   - `/api/transcribe` 请求
   - 响应内容

### 查看数据库
在Supabase控制台检查messages表：
- `transcript` 字段是否已更新
- `metadata.duration` 是否正确

## 📊 预期结果

### 成功的转写
```json
{
  "success": true,
  "transcript": "你好我想咨询一下退货流程",
  "message": "转写成功"
}
```

### 数据库更新
messages表中对应的记录：
```
transcript: "你好我想咨询一下退货流程"
metadata: {"duration": 3}
```

## 🔧 如果需要优化

### 1. 音频格式转换（如果webm不支持）

可以在前端录音时使用wav格式：
```typescript
const mr = new MediaRecorder(stream, { 
  mimeType: 'audio/wav'  // 改为wav
});
```

### 2. 使用录音文件识别API（长音频）

如果语音超过60秒，需要改用录音文件识别API（费用更低）

### 3. 添加音频格式转换

在后端添加ffmpeg转换webm到wav

## 📞 技术支持

遇到问题可以：
1. 查看后端日志：找到具体的错误信息
2. 查看阿里云控制台：智能语音交互 → API调用日志
3. 检查网络：确保能访问阿里云服务

---

现在可以开始测试了！🚀
